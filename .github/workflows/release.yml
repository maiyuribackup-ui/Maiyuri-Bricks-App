name: Release

on:
  push:
    tags:
      - 'v*'

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.PREV_TAG }}"

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            # Get commits since previous tag
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_COUNT=$(git rev-list --count ${PREV_TAG}..HEAD)
          fi

          # Count by type
          FEAT_COUNT=$(echo "$CHANGELOG" | grep -c "^- feat:" || echo "0")
          FIX_COUNT=$(echo "$CHANGELOG" | grep -c "^- fix:" || echo "0")
          OTHER_COUNT=$((COMMIT_COUNT - FEAT_COUNT - FIX_COUNT))

          # Save to file for multi-line output
          echo "$CHANGELOG" > changelog.txt
          echo "changelog_file=changelog.txt" >> $GITHUB_OUTPUT
          echo "commit_count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT
          echo "feat_count=${FEAT_COUNT}" >> $GITHUB_OUTPUT
          echo "fix_count=${FIX_COUNT}" >> $GITHUB_OUTPUT
          echo "other_count=${OTHER_COUNT}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: changelog.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Telegram notification
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PREV_TAG="${{ steps.prev_tag.outputs.PREV_TAG }}"
          COMMIT_COUNT="${{ steps.changelog.outputs.commit_count }}"
          FEAT_COUNT="${{ steps.changelog.outputs.feat_count }}"
          FIX_COUNT="${{ steps.changelog.outputs.fix_count }}"

          # Build compare URL if previous tag exists
          if [ -n "$PREV_TAG" ]; then
            COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}"
            COMPARE_TEXT="%0A%0A<a href='${COMPARE_URL}'>Compare Changes</a>"
          else
            COMPARE_TEXT=""
          fi

          # Build stats line
          STATS="üìä ${COMMIT_COUNT} commits"
          if [ "$FEAT_COUNT" -gt 0 ]; then
            STATS="${STATS} | ‚ú® ${FEAT_COUNT} features"
          fi
          if [ "$FIX_COUNT" -gt 0 ]; then
            STATS="${STATS} | üêõ ${FIX_COUNT} fixes"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>üöÄ New Release: ${VERSION}</b>%0A%0A<b>Repository:</b> ${{ github.repository }}%0A<b>Author:</b> ${{ github.actor }}%0A%0A${STATS}%0A%0A<a href='${{ github.server_url }}/${{ github.repository }}/releases/tag/${VERSION}'>üì¶ View Release</a>${COMPARE_TEXT}"
